#include <arith_uint256.h>
#include <chainparams.h>
#include <iostream>
#include <qtum/fvmsupplycontrol.h>
#include <qtum/qtumDGP.h>
#include <util/system.h>
#include <validation.h>

const std::string supplyControlCode = "608060405234801561001057600080fd5b50600436106100b45760003560e01c80638a6f5a59116100715780638a6f5a59146101b55780638fb872ba146101e5578063da9fc92614610215578063eb9019d414610248578063f8ce560a14610278578063fe0d94c1146102a8576100b4565b806302a251a3146100b95780631c9b2f35146100d757806342d21ef7146101075780634385963214610137578063555567c0146101675780635678138814610185575b600080fd5b6100c16102d8565b6040516100ce919061256c565b60405180910390f35b6100f160048036038101906100ec91906125c7565b6102e2565b6040516100fe9190612645565b60405180910390f35b610121600480360381019061011c91906125c7565b61032d565b60405161012e91906126d7565b60405180910390f35b610151600480360381019061014c9190612750565b610471565b60405161015e91906127ab565b60405180910390f35b61016f610485565b60405161017c919061256c565b60405180910390f35b61019f600480360381019061019a91906127ff565b61048a565b6040516101ac919061256c565b60405180910390f35b6101cf60048036038101906101ca91906125c7565b6105ea565b6040516101dc919061290e565b60405180910390f35b6101ff60048036038101906101fa9190612a3a565b610742565b60405161020c919061256c565b60405180910390f35b61022f600480360381019061022a91906125c7565b6110ec565b60405161023f9493929190612e1b565b60405180910390f35b610262600480360381019061025d9190612e75565b61134d565b60405161026f919061256c565b60405180910390f35b610292600480360381019061028d91906125c7565b611361565b60405161029f919061256c565b60405180910390f35b6102c260048036038101906102bd91906125c7565b611433565b6040516102cf919061256c565b60405180910390f35b6000611680905090565b6102ea612276565b6002600083815260200190815260200160002060405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b6000806000808481526020019081526020016000209050600081600001540361038b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161038290612f12565b60405180910390fd5b8060010160199054906101000a900460ff16156103ac57600591505061046c565b8060010160189054906101000a900460ff16156103cd57600291505061046c565b60004390508160010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff168110156104075760009250505061046c565b8160010160109054906101000a900467ffffffffffffffff1667ffffffffffffffff16811161043b5760019250505061046c565b61044484611517565b8015610455575061045484611788565b5b156104655760039250505061046c565b6004925050505b919050565b600061047d83836119f4565b905092915050565b600090565b6000806000808581526020019081526020016000209050600160058111156104b5576104b4612660565b5b6104be8561032d565b60058111156104d0576104cf612660565b5b14610510576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161050790612f7e565b60405180910390fd5b600061053e338360010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff16611a5c565b905060008111610583576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161057a90612fea565b60405180910390fd5b61058f85338684611b83565b3373ffffffffffffffffffffffffffffffffffffffff167f251f168c3d37dca4f3922f4aa12852da0c3de8ef70710e0cf58eba85805168a286866040516105d7929190613019565b60405180910390a2809250505092915050565b6105f2612297565b6000808381526020019081526020016000206040518060e0016040529081600082015481526020016001820160009054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160089054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160109054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160189054906101000a900460ff161515151581526020016001820160199054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250509050919050565b600061074c611d36565b73ffffffffffffffffffffffffffffffffffffffff166324d7806c336040518263ffffffff1660e01b81526004016107849190613051565b602060405180830381865afa1580156107a1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107c59190613098565b610804576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107fb90613111565b60405180910390fd5b438811610846576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161083d9061317d565b60405180910390fd5b84849050878790501461088e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108859061320f565b60405180910390fd5b8282905087879050146108d6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108cd906132a1565b60405180910390fd5b6000886040516020016108e991906132e2565b6040516020818303038152906040528051906020012060001c90506000600460008b8152602001908152602001600020604051806080016040529081600082015481526020016001820180548060200260200160405190810160405280929190818152602001828054801561097d57602002820191906000526020600020905b815481526020019060010190808311610969575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610a575783829060005260206000200180546109ca9061332c565b80601f01602080910402602001604051908101604052809291908181526020018280546109f69061332c565b8015610a435780601f10610a1857610100808354040283529160200191610a43565b820191906000526020600020905b815481529060010190602001808311610a2657829003601f168201915b5050505050815260200190600101906109ab565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015610b30578382906000526020600020018054610aa39061332c565b80601f0160208091040260200160405190810160405280929190818152602001828054610acf9061332c565b8015610b1c5780601f10610af157610100808354040283529160200191610b1c565b820191906000526020600020905b815481529060010190602001808311610aff57829003601f168201915b505050505081526020019060010190610a84565b505050508152505090506000816000015114610b81576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b78906133a9565b60405180910390fd5b600081602001515114610bc9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bc090613415565b60405180910390fd5b600081604001515114610c11576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c08906134a7565b60405180910390fd5b600081606001515114610c59576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c5090613513565b60405180910390fd5b6000600560008481526020019081526020016000206040518060800160405290816000820154815260200160018201805480602002602001604051908101604052809291908181526020018280548015610cd257602002820191906000526020600020905b815481526020019060010190808311610cbe575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610dac578382906000526020600020018054610d1f9061332c565b80601f0160208091040260200160405190810160405280929190818152602001828054610d4b9061332c565b8015610d985780601f10610d6d57610100808354040283529160200191610d98565b820191906000526020600020905b815481529060010190602001808311610d7b57829003601f168201915b505050505081526020019060010190610d00565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015610e85578382906000526020600020018054610df89061332c565b80601f0160208091040260200160405190810160405280929190818152602001828054610e249061332c565b8015610e715780601f10610e4657610100808354040283529160200191610e71565b820191906000526020600020905b815481529060010190602001808311610e5457829003601f168201915b505050505081526020019060010190610dd9565b505050508152505090506000816000015114610ed6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ecd9061357f565b60405180910390fd5b600081602001515114610f1e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f1590613611565b60405180910390fd5b600081604001515114610f66576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f5d906136a3565b60405180910390fd5b600081606001515114610fae576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fa590613735565b60405180910390fd5b8a816000018181525050898980806020026020016040519081016040528093929190818152602001838360200280828437600081840152601f19601f82011690508083019250505050505050816020018190525087879061100f9190613938565b81604001819052508585906110249190613aa1565b8160600181905250806005600085815260200190815260200160002060008201518160000155602082015181600101908051906020019061106692919061230c565b506040820151816002019080519060200190611083929190612359565b5060608201518160030190805190602001906110a09291906123b2565b509050506110ad83611d60565b50827fc2c021f5d73c63c481d336fbbafec58f694fc45095f00b02d2deb8cca59afe0760405160405180910390a2829350505050979650505050505050565b60006060806060600060046000878152602001908152602001600020604051806080016040529081600082015481526020016001820180548060200260200160405190810160405280929190818152602001828054801561116c57602002820191906000526020600020905b815481526020019060010190808311611158575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b828210156112465783829060005260206000200180546111b99061332c565b80601f01602080910402602001604051908101604052809291908181526020018280546111e59061332c565b80156112325780601f1061120757610100808354040283529160200191611232565b820191906000526020600020905b81548152906001019060200180831161121557829003601f168201915b50505050508152602001906001019061119a565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b8282101561131f5783829060005260206000200180546112929061332c565b80601f01602080910402602001604051908101604052809291908181526020018280546112be9061332c565b801561130b5780601f106112e05761010080835404028352916020019161130b565b820191906000526020600020905b8154815290600101906020018083116112ee57829003601f168201915b505050505081526020019060010190611273565b5050505081525050905080600001518160200151826040015183606001519450945094509450509193509193565b60006113598383611a5c565b905092915050565b60008061136c611d36565b73ffffffffffffffffffffffffffffffffffffffff16633de6803b846040518263ffffffff1660e01b81526004016113a4919061256c565b602060405180830381865afa1580156113c1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113e59190613acb565b905060006003826113f69190613b27565b14611402576001611405565b60005b60ff1660036002836114179190613b87565b6114219190613bc9565b61142b9190613bfa565b915050919050565b60006003600581111561144957611448612660565b5b6114528361032d565b600581111561146457611463612660565b5b146114a4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161149b90613c7a565b60405180910390fd5b6000806000848152602001908152602001600020905060018160010160196101000a81548160ff021916908315150217905550827f712ae1383f79ac853f8d882153778e0260ef8f03b504e2866e0593e04d2b291f60405160405180910390a261150d83611eda565b5082915050919050565b6000806000808481526020019081526020016000206040518060e0016040529081600082015481526020016001820160009054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160089054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160109054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160189054906101000a900460ff161515151581526020016001820160199054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250509050600060026000836000015181526020019081526020016000206040518060600160405290816000820154815260200160018201548152602001600282015481525050905060006116c2836020015167ffffffffffffffff16611361565b905060006116ce611d36565b73ffffffffffffffffffffffffffffffffffffffff16633de6803b85602001516040518263ffffffff1660e01b815260040161170a9190613cd5565b602060405180830381865afa158015611727573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061174b9190613acb565b905081836020015110158061177d575081816117679190613cf0565b8360000151846040015161177b9190613bfa565b115b945050505050919050565b6000806000808481526020019081526020016000206040518060e0016040529081600082015481526020016001820160009054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160089054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160109054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160189054906101000a900460ff161515151581526020016001820160199054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250509050600060026000858152602001908152602001600020604051806060016040529081600082015481526020016001820154815260200160028201548152505090506000611920611d36565b73ffffffffffffffffffffffffffffffffffffffff16633de6803b84602001516040518263ffffffff1660e01b815260040161195c9190613cd5565b602060405180830381865afa158015611979573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061199d9190613acb565b905060006003826119ae9190613b27565b146119ba5760016119bd565b60005b60ff1660036002836119cf9190613b87565b6119d99190613bc9565b6119e39190613bfa565b826020015110159350505050919050565b60006003600084815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b600080611a67611d36565b90508073ffffffffffffffffffffffffffffffffffffffff1663e62092be85856040518363ffffffff1660e01b8152600401611aa4929190613d24565b602060405180830381865afa158015611ac1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611ae59190613098565b80611b6857508073ffffffffffffffffffffffffffffffffffffffff16635cadf6dd85856040518363ffffffff1660e01b8152600401611b26929190613d24565b602060405180830381865afa158015611b43573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611b679190613098565b5b15611b77576001915050611b7d565b60009150505b92915050565b6000600260008681526020019081526020016000209050611ba485856119f4565b15611be4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611bdb90613d99565b60405180910390fd5b60038360ff1610611c2a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c2190613e05565b60405180910390fd5b600280811115611c3d57611c3c612660565b5b60ff168360ff1603611c695781816000016000828254611c5d9190613bfa565b92505081905550611cc6565b60016002811115611c7d57611c7c612660565b5b60ff168360ff1603611ca95781816001016000828254611c9d9190613bfa565b92505081905550611cc5565b81816002016000828254611cbd9190613bfa565b925050819055505b5b60016003600087815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505050505050565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060008084815260200190815260200160002090506000816000015414611dbe576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611db590613e71565b60405180910390fd5b828160000181905550438160010160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550611dfa610485565b43611e059190613bfa565b8160010160086101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550611e376102d8565b8160010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff16611e649190613bfa565b8160010160106101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550338160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082915050919050565b600080600560008481526020019081526020016000206040518060800160405290816000820154815260200160018201805480602002602001604051908101604052809291908181526020018280548015611f5457602002820191906000526020600020905b815481526020019060010190808311611f40575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b8282101561202e578382906000526020600020018054611fa19061332c565b80601f0160208091040260200160405190810160405280929190818152602001828054611fcd9061332c565b801561201a5780601f10611fef5761010080835404028352916020019161201a565b820191906000526020600020905b815481529060010190602001808311611ffd57829003601f168201915b505050505081526020019060010190611f82565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b8282101561210757838290600052602060002001805461207a9061332c565b80601f01602080910402602001604051908101604052809291908181526020018280546120a69061332c565b80156120f35780601f106120c8576101008083540402835291602001916120f3565b820191906000526020600020905b8154815290600101906020018083116120d657829003601f168201915b50505050508152602001906001019061205b565b505050508152505090506005600084815260200190815260200160002060008082016000905560018201600061213d919061240b565b60028201600061214d919061242c565b60038201600061215d919061244d565b5050438160000151116121a5576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161219c90613f03565b60405180910390fd5b60006004600083600001518152602001908152602001600020905083816000018190555081602001518160010190805190602001906121e592919061230c565b508160400151816002019080519060200190612202929190612359565b50816060015181600301908051906020019061221f9291906123b2565b5081600001517f229ec54ad02292d39d7686f16ddb7decef549d68d24423b7df15d57aead463d983602001518460400151856060015160405161226493929190613f23565b60405180910390a28392505050919050565b60405180606001604052806000815260200160008152602001600081525090565b6040518060e0016040528060008152602001600067ffffffffffffffff168152602001600067ffffffffffffffff168152602001600067ffffffffffffffff168152602001600015158152602001600015158152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b828054828255906000526020600020908101928215612348579160200282015b8281111561234757825182559160200191906001019061232c565b5b509050612355919061246e565b5090565b8280548282559060005260206000209081019282156123a1579160200282015b828111156123a05782518290816123909190614111565b5091602001919060010190612379565b5b5090506123ae919061248b565b5090565b8280548282559060005260206000209081019282156123fa579160200282015b828111156123f95782518290816123e9919061423e565b50916020019190600101906123d2565b5b50905061240791906124af565b5090565b5080546000825590600052602060002090810190612429919061246e565b50565b508054600082559060005260206000209081019061244a919061248b565b50565b508054600082559060005260206000209081019061246b91906124af565b50565b5b8082111561248757600081600090555060010161246f565b5090565b5b808211156124ab57600081816124a291906124d3565b5060010161248c565b5090565b5b808211156124cf57600081816124c69190612513565b506001016124b0565b5090565b5080546124df9061332c565b6000825580601f106124f15750612510565b601f01602090049060005260206000209081019061250f919061246e565b5b50565b50805461251f9061332c565b6000825580601f106125315750612550565b601f01602090049060005260206000209081019061254f919061246e565b5b50565b6000819050919050565b61256681612553565b82525050565b6000602082019050612581600083018461255d565b92915050565b6000604051905090565b600080fd5b600080fd5b6125a481612553565b81146125af57600080fd5b50565b6000813590506125c18161259b565b92915050565b6000602082840312156125dd576125dc612591565b5b60006125eb848285016125b2565b91505092915050565b6125fd81612553565b82525050565b60608201600082015161261960008501826125f4565b50602082015161262c60208501826125f4565b50604082015161263f60408501826125f4565b50505050565b600060608201905061265a6000830184612603565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b600681106126a05761269f612660565b5b50565b60008190506126b18261268f565b919050565b60006126c1826126a3565b9050919050565b6126d1816126b6565b82525050565b60006020820190506126ec60008301846126c8565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061271d826126f2565b9050919050565b61272d81612712565b811461273857600080fd5b50565b60008135905061274a81612724565b92915050565b6000806040838503121561276757612766612591565b5b6000612775858286016125b2565b92505060206127868582860161273b565b9150509250929050565b60008115159050919050565b6127a581612790565b82525050565b60006020820190506127c0600083018461279c565b92915050565b600060ff82169050919050565b6127dc816127c6565b81146127e757600080fd5b50565b6000813590506127f9816127d3565b92915050565b6000806040838503121561281657612815612591565b5b6000612824858286016125b2565b9250506020612835858286016127ea565b9150509250929050565b600067ffffffffffffffff82169050919050565b61285c8161283f565b82525050565b61286b81612790565b82525050565b61287a81612712565b82525050565b60e08201600082015161289660008501826125f4565b5060208201516128a96020850182612853565b5060408201516128bc6040850182612853565b5060608201516128cf6060850182612853565b5060808201516128e26080850182612862565b5060a08201516128f560a0850182612862565b5060c082015161290860c0850182612871565b50505050565b600060e0820190506129236000830184612880565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f84011261294e5761294d612929565b5b8235905067ffffffffffffffff81111561296b5761296a61292e565b5b60208301915083602082028301111561298757612986612933565b5b9250929050565b60008083601f8401126129a4576129a3612929565b5b8235905067ffffffffffffffff8111156129c1576129c061292e565b5b6020830191508360208202830111156129dd576129dc612933565b5b9250929050565b60008083601f8401126129fa576129f9612929565b5b8235905067ffffffffffffffff811115612a1757612a1661292e565b5b602083019150836020820283011115612a3357612a32612933565b5b9250929050565b60008060008060008060006080888a031215612a5957612a58612591565b5b6000612a678a828b016125b2565b975050602088013567ffffffffffffffff811115612a8857612a87612596565b5b612a948a828b01612938565b9650965050604088013567ffffffffffffffff811115612ab757612ab6612596565b5b612ac38a828b0161298e565b9450945050606088013567ffffffffffffffff811115612ae657612ae5612596565b5b612af28a828b016129e4565b925092505092959891949750929550565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000612b3b83836125f4565b60208301905092915050565b6000602082019050919050565b6000612b5f82612b03565b612b698185612b0e565b9350612b7483612b1f565b8060005b83811015612ba5578151612b8c8882612b2f565b9750612b9783612b47565b925050600181019050612b78565b5085935050505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b60005b83811015612c18578082015181840152602081019050612bfd565b60008484015250505050565b6000601f19601f8301169050919050565b6000612c4082612bde565b612c4a8185612be9565b9350612c5a818560208601612bfa565b612c6381612c24565b840191505092915050565b6000612c7a8383612c35565b905092915050565b6000602082019050919050565b6000612c9a82612bb2565b612ca48185612bbd565b935083602082028501612cb685612bce565b8060005b85811015612cf25784840389528151612cd38582612c6e565b9450612cde83612c82565b925060208a01995050600181019050612cba565b50829750879550505050505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b6000612d5782612d30565b612d618185612d3b565b9350612d71818560208601612bfa565b612d7a81612c24565b840191505092915050565b6000612d918383612d4c565b905092915050565b6000602082019050919050565b6000612db182612d04565b612dbb8185612d0f565b935083602082028501612dcd85612d20565b8060005b85811015612e095784840389528151612dea8582612d85565b9450612df583612d99565b925060208a01995050600181019050612dd1565b50829750879550505050505092915050565b6000608082019050612e30600083018761255d565b8181036020830152612e428186612b54565b90508181036040830152612e568185612c8f565b90508181036060830152612e6a8184612da6565b905095945050505050565b60008060408385031215612e8c57612e8b612591565b5b6000612e9a8582860161273b565b9250506020612eab858286016125b2565b9150509250929050565b600082825260208201905092915050565b7f70726f706f73616c206973206e6f742065786973747300000000000000000000600082015250565b6000612efc601683612eb5565b9150612f0782612ec6565b602082019050919050565b60006020820190508181036000830152612f2b81612eef565b9050919050565b7f70726f706f73616c206973206e6f742061637469766500000000000000000000600082015250565b6000612f68601683612eb5565b9150612f7382612f32565b602082019050919050565b60006020820190508181036000830152612f9781612f5b565b9050919050565b7f6e6f20766f746520726967687400000000000000000000000000000000000000600082015250565b6000612fd4600d83612eb5565b9150612fdf82612f9e565b602082019050919050565b6000602082019050818103600083015261300381612fc7565b9050919050565b613013816127c6565b82525050565b600060408201905061302e600083018561255d565b61303b602083018461300a565b9392505050565b61304b81612712565b82525050565b60006020820190506130666000830184613042565b92915050565b61307581612790565b811461308057600080fd5b50565b6000815190506130928161306c565b92915050565b6000602082840312156130ae576130ad612591565b5b60006130bc84828501613083565b91505092915050565b7f4f6e6c792061646d696e2063616e206163636573730000000000000000000000600082015250565b60006130fb601583612eb5565b9150613106826130c5565b602082019050919050565b6000602082019050818103600083015261312a816130ee565b9050919050565b7f626c6f636b206e756d62657220697320616c7265616479207061737300000000600082015250565b6000613167601c83612eb5565b915061317282613131565b602082019050919050565b600060208201905081810360008301526131968161315a565b9050919050565b7f6c656e67746873206f66205f616d6f756e747320616e64205f7363726970745460008201527f797065732073686f756c6420626520657175616c000000000000000000000000602082015250565b60006131f9603483612eb5565b91506132048261319d565b604082019050919050565b60006020820190508181036000830152613228816131ec565b9050919050565b7f6c656e67746873206f66205f616d6f756e747320616e64205f7363726970747360008201527f2073686f756c6420626520657175616c00000000000000000000000000000000602082015250565b600061328b603083612eb5565b91506132968261322f565b604082019050919050565b600060208201905081810360008301526132ba8161327e565b9050919050565b6000819050919050565b6132dc6132d782612553565b6132c1565b82525050565b60006132ee82846132cb565b60208201915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061334457607f821691505b602082108103613357576133566132fd565b5b50919050565b7f6d696e7420697320616c72656164792063726561746564000000000000000000600082015250565b6000613393601783612eb5565b915061339e8261335d565b602082019050919050565b600060208201905081810360008301526133c281613386565b9050919050565b7f6c697374206f6620616d6f756e74732073686f756c6420626520656d70747900600082015250565b60006133ff601f83612eb5565b915061340a826133c9565b602082019050919050565b6000602082019050818103600083015261342e816133f2565b9050919050565b7f6c697374206f662073637269707454797065732073686f756c6420626520656d60008201527f7074790000000000000000000000000000000000000000000000000000000000602082015250565b6000613491602383612eb5565b915061349c82613435565b604082019050919050565b600060208201905081810360008301526134c081613484565b9050919050565b7f6c697374206f6620736372697074732073686f756c6420626520656d70747900600082015250565b60006134fd601f83612eb5565b9150613508826134c7565b602082019050919050565b6000602082019050818103600083015261352c816134f0565b9050919050565b7f70726f706f73616c20697320616c726561647920637265617465640000000000600082015250565b6000613569601b83612eb5565b915061357482613533565b602082019050919050565b600060208201905081810360008301526135988161355c565b9050919050565b7f5b70726f706f73616c5d206c697374206f6620616d6f756e74732073686f756c60008201527f6420626520656d70747900000000000000000000000000000000000000000000602082015250565b60006135fb602a83612eb5565b91506136068261359f565b604082019050919050565b6000602082019050818103600083015261362a816135ee565b9050919050565b7f5b70726f706f73616c5d206c697374206f66207363726970745479706573207360008201527f686f756c6420626520656d707479000000000000000000000000000000000000602082015250565b600061368d602e83612eb5565b915061369882613631565b604082019050919050565b600060208201905081810360008301526136bc81613680565b9050919050565b7f5b70726f706f73616c5d206c697374206f6620736372697074732073686f756c60008201527f6420626520656d70747900000000000000000000000000000000000000000000602082015250565b600061371f602a83612eb5565b915061372a826136c3565b604082019050919050565b6000602082019050818103600083015261374e81613712565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61378d82612c24565b810181811067ffffffffffffffff821117156137ac576137ab613755565b5b80604052505050565b60006137bf612587565b90506137cb8282613784565b919050565b600067ffffffffffffffff8211156137eb576137ea613755565b5b602082029050602081019050919050565b600080fd5b600067ffffffffffffffff82111561381c5761381b613755565b5b61382582612c24565b9050602081019050919050565b82818337600083830152505050565b600061385461384f84613801565b6137b5565b9050828152602081018484840111156138705761386f6137fc565b5b61387b848285613832565b509392505050565b600082601f83011261389857613897612929565b5b81356138a8848260208601613841565b91505092915050565b60006138c46138bf846137d0565b6137b5565b905080838252602082019050602084028301858111156138e7576138e6612933565b5b835b8181101561392e57803567ffffffffffffffff81111561390c5761390b612929565b5b8086016139198982613883565b855260208501945050506020810190506138e9565b5050509392505050565b60006139453684846138b1565b905092915050565b600067ffffffffffffffff82111561396857613967613755565b5b602082029050602081019050919050565b600067ffffffffffffffff82111561399457613993613755565b5b61399d82612c24565b9050602081019050919050565b60006139bd6139b884613979565b6137b5565b9050828152602081018484840111156139d9576139d86137fc565b5b6139e4848285613832565b509392505050565b600082601f830112613a0157613a00612929565b5b8135613a118482602086016139aa565b91505092915050565b6000613a2d613a288461394d565b6137b5565b90508083825260208201905060208402830185811115613a5057613a4f612933565b5b835b81811015613a9757803567ffffffffffffffff811115613a7557613a74612929565b5b808601613a8289826139ec565b85526020850194505050602081019050613a52565b5050509392505050565b6000613aae368484613a1a565b905092915050565b600081519050613ac58161259b565b92915050565b600060208284031215613ae157613ae0612591565b5b6000613aef84828501613ab6565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000613b3282612553565b9150613b3d83612553565b925082613b4d57613b4c613af8565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000613b9282612553565b9150613b9d83612553565b9250828202613bab81612553565b91508282048414831517613bc257613bc1613b58565b5b5092915050565b6000613bd482612553565b9150613bdf83612553565b925082613bef57613bee613af8565b5b828204905092915050565b6000613c0582612553565b9150613c1083612553565b9250828201905080821115613c2857613c27613b58565b5b92915050565b7f50726f706f73616c206973206e6f742073756363657373656400000000000000600082015250565b6000613c64601983612eb5565b9150613c6f82613c2e565b602082019050919050565b60006020820190508181036000830152613c9381613c57565b9050919050565b6000819050919050565b6000613cbf613cba613cb58461283f565b613c9a565b612553565b9050919050565b613ccf81613ca4565b82525050565b6000602082019050613cea6000830184613cc6565b92915050565b6000613cfb82612553565b9150613d0683612553565b9250828203905081811115613d1e57613d1d613b58565b5b92915050565b6000604082019050613d396000830185613042565b613d46602083018461255d565b9392505050565b7f616c726561647920766f74650000000000000000000000000000000000000000600082015250565b6000613d83600c83612eb5565b9150613d8e82613d4d565b602082019050919050565b60006020820190508181036000830152613db281613d76565b9050919050565b7f696e76616c696420766f74650000000000000000000000000000000000000000600082015250565b6000613def600c83612eb5565b9150613dfa82613db9565b602082019050919050565b60006020820190508181036000830152613e1e81613de2565b9050919050565b7f70726f706f73616c20616c726561647920657869737473000000000000000000600082015250565b6000613e5b601783612eb5565b9150613e6682613e25565b602082019050919050565b60006020820190508181036000830152613e8a81613e4e565b9050919050565b7f70726f706f73616c206d757374206265206164646564206265666f7265206d6960008201527f6e74696e6720626c6f636b000000000000000000000000000000000000000000602082015250565b6000613eed602b83612eb5565b9150613ef882613e91565b604082019050919050565b60006020820190508181036000830152613f1c81613ee0565b9050919050565b60006060820190508181036000830152613f3d8186612b54565b90508181036020830152613f518185612c8f565b90508181036040830152613f658184612da6565b9050949350505050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613fd17fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613f94565b613fdb8683613f94565b95508019841693508086168417925050509392505050565b600061400e61400961400484612553565b613c9a565b612553565b9050919050565b6000819050919050565b61402883613ff3565b61403c61403482614015565b848454613fa1565b825550505050565b600090565b614051614044565b61405c81848461401f565b505050565b5b8181101561408057614075600082614049565b600181019050614062565b5050565b601f8211156140c55761409681613f6f565b61409f84613f84565b810160208510156140ae578190505b6140c26140ba85613f84565b830182614061565b50505b505050565b600082821c905092915050565b60006140e8600019846008026140ca565b1980831691505092915050565b600061410183836140d7565b9150826002028217905092915050565b61411a82612bde565b67ffffffffffffffff81111561413357614132613755565b5b61413d825461332c565b614148828285614084565b600060209050601f83116001811461417b5760008415614169578287015190505b61417385826140f5565b8655506141db565b601f19841661418986613f6f565b60005b828110156141b15784890151825560018201915060208501945060208101905061418c565b868310156141ce57848901516141ca601f8916826140d7565b8355505b6001600288020188555050505b505050505050565b60008190508160005260206000209050919050565b601f8211156142395761420a816141e3565b61421384613f84565b81016020851015614222578190505b61423661422e85613f84565b830182614061565b50505b505050565b61424782612d30565b67ffffffffffffffff8111156142605761425f613755565b5b61426a825461332c565b6142758282856141f8565b600060209050601f8311600181146142a85760008415614296578287015190505b6142a085826140f5565b865550614308565b601f1984166142b6866141e3565b60005b828110156142de578489015182556001820191506020850194506020810190506142b9565b868310156142fb57848901516142f7601f8916826140d7565b8355505b6001600288020188555050505b50505050505056fea26469706673582212200d53dac453c48eabbede7e3741fdf4301da6e6e76944815e903e1e9aecf0283f64736f6c63430008120033";
const std::string supplyControlABI = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"block\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"},{\"indexed\":false,\"internalType\":\"string[]\",\"name\":\"scriptTypes\",\"type\":\"string[]\"},{\"indexed\":false,\"internalType\":\"bytes[]\",\"name\":\"scripts\",\"type\":\"bytes[]\"}],\"name\":\"MintAdded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalCancalled\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalCreated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalExecuted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"voter\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint8\",\"name\":\"casted\",\"type\":\"uint8\"}],\"name\":\"VoteCast\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"uint8\",\"name\":\"support\",\"type\":\"uint8\"}],\"name\":\"castVote\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"execute\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_block\",\"type\":\"uint256\"}],\"name\":\"getMint\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"},{\"internalType\":\"string[]\",\"name\":\"scriptTypes\",\"type\":\"string[]\"},{\"internalType\":\"bytes[]\",\"name\":\"scripts\",\"type\":\"bytes[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"getProposalMeta\",\"outputs\":[{\"components\":[{\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"},{\"internalType\":\"uint64\",\"name\":\"proposedAt\",\"type\":\"uint64\"},{\"internalType\":\"uint64\",\"name\":\"voteStart\",\"type\":\"uint64\"},{\"internalType\":\"uint64\",\"name\":\"voteEnd\",\"type\":\"uint64\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"executed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"proposer\",\"type\":\"address\"}],\"internalType\":\"structVotable.ProposalMeta\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"getProposalVote\",\"outputs\":[{\"components\":[{\"internalType\":\"uint256\",\"name\":\"againstVotes\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"forVotes\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"abstainVotes\",\"type\":\"uint256\"}],\"internalType\":\"structGovVotable.ProposalVote\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"timepoint\",\"type\":\"uint256\"}],\"name\":\"getVotes\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"hasVoted\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_block\",\"type\":\"uint256\"},{\"internalType\":\"uint256[]\",\"name\":\"_amounts\",\"type\":\"uint256[]\"},{\"internalType\":\"string[]\",\"name\":\"_scriptTypes\",\"type\":\"string[]\"},{\"internalType\":\"bytes[]\",\"name\":\"_scripts\",\"type\":\"bytes[]\"}],\"name\":\"propose\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"timepoint\",\"type\":\"uint256\"}],\"name\":\"quorum\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"status\",\"outputs\":[{\"internalType\":\"enumIVotable.ProposalStatus\",\"name\":\"\",\"type\":\"uint8\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"votingDeley\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"votingPeriod\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"}]";
const ContractABI contractSupplyControlABI = supplyControlABI;

FVMSupplyControl::FVMSupplyControl()
{
    supplyControlAddress = uintToh160(Params().GetConsensus().supplyControlAddress);
}

bool FVMSupplyControl::GetMint(int nHeight, std::vector<Mint> &out, CChainState &chain) {
    const static std::string method = "getMint";
    const auto abi = contractSupplyControlABI[method];

    std::vector<std::vector<std::string>> inputValues = {
        {i64tostr(nHeight)},
    };

    std::vector<ParameterABI::ErrorType> inputErrors;
    std::string inputData;

    if (!abi.abiIn(inputValues, inputData, inputErrors)) {
        return error("Fail to constuct input data");
    }

    std::vector<ResultExecute> execResults;
    {
        LOCK(cs_main);
        execResults = CallContract(supplyControlAddress, ParseHex(inputData), chain);
    }

    if (execResults.size() < 1) {
        return error("Fail to CallContract to get mint requests");
    }
    
    std::string outputData = HexStr(execResults[0].execRes.output);
    std::vector<std::vector<std::string>> outputValues;
    std::vector<ParameterABI::ErrorType> outputErrors;
    if (!abi.abiOut(outputData, outputValues, outputErrors)) {
        return error("Failed to deserialize get mint output parameters");
    }

    if (outputValues.size() != abi.outputs.size()) {
        return error("Failed to deserialize get poa output, size doesn't match");
    }

    std::vector<CAmount> amounts;
    std::vector<std::string> scriptsTypes;
    std::vector<CScript> scripts;
    try {
        for (std::size_t i = 0; i < outputValues.size(); i++) {

            std::vector<std::string> value = outputValues[i];

            std::string name = abi.outputs[i].name;
            if (name == "proposalId") {
                // don't need it now
            } else if (name == "amounts") {
                for (auto const &v: value) {
                    amounts.emplace_back(atoi64(v));
                }
            } else if (name == "scriptTypes") {
                scriptsTypes = value;
            } else if (name == "scripts") {
                for (auto const &v: value) {
                    auto script = ParseHex(v);
                    scripts.emplace_back(script.begin(), script.end());
                }
            } else {
                return error("Invalid get supply control output name");
            }
        }
    } catch(...) {
        return error("Invalid get supply control");
    }

    if (amounts.size() != scriptsTypes.size()) {
        return error("Invalid script types size");
    }

    if (amounts.size() != scripts.size()) {
        return error("Invalid scripts size");
    }

    for (size_t i = 0; i < amounts.size(); i++) {
        out.emplace_back(scriptsTypes[i], scripts[i], amounts[i]);
    }

    return true;
}
