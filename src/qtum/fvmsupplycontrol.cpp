#include <arith_uint256.h>
#include <chainparams.h>
#include <iostream>
#include <qtum/fvmsupplycontrol.h>
#include <qtum/qtumDGP.h>
#include <util/system.h>
#include <validation.h>

const std::string supplyControlCode = "608060405234801561001057600080fd5b50600436106100cf5760003560e01c80638a6f5a591161008c578063da9fc92611610066578063da9fc9261461024e578063eb9019d414610281578063f8ce560a146102b1578063fe0d94c1146102e1576100cf565b80638a6f5a59146101d05780638fb872ba14610200578063c162d7da14610230576100cf565b806302a251a3146100d45780631c9b2f35146100f257806342d21ef7146101225780634385963214610152578063555567c01461018257806356781388146101a0575b600080fd5b6100dc610311565b6040516100e9919061230e565b60405180910390f35b61010c60048036038101906101079190612369565b61031b565b60405161011991906123e7565b60405180910390f35b61013c60048036038101906101379190612369565b610366565b6040516101499190612479565b60405180910390f35b61016c600480360381019061016791906124f2565b6104aa565b604051610179919061254d565b60405180910390f35b61018a6104be565b604051610197919061230e565b60405180910390f35b6101ba60048036038101906101b591906125a1565b6104c3565b6040516101c7919061230e565b60405180910390f35b6101ea60048036038101906101e59190612369565b610623565b6040516101f791906126b0565b60405180910390f35b61021a600480360381019061021591906127dc565b61077b565b604051610227919061230e565b60405180910390f35b610238611125565b60405161024591906128b4565b60405180910390f35b61026860048036038101906102639190612369565b61114f565b6040516102789493929190612be7565b60405180910390f35b61029b60048036038101906102969190612c41565b6113b0565b6040516102a8919061230e565b60405180910390f35b6102cb60048036038101906102c69190612369565b6113c4565b6040516102d8919061230e565b60405180910390f35b6102fb60048036038101906102f69190612369565b611472565b604051610308919061230e565b60405180910390f35b6000611680905090565b610323612018565b6002600083815260200190815260200160002060405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600080600080848152602001908152602001600020905060008160000154036103c4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103bb90612cde565b60405180910390fd5b8060010160199054906101000a900460ff16156103e55760059150506104a5565b8060010160189054906101000a900460ff16156104065760029150506104a5565b60004390508160010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff16811015610440576000925050506104a5565b8160010160109054906101000a900467ffffffffffffffff1667ffffffffffffffff168111610474576001925050506104a5565b61047d84611556565b801561048e575061048d84611733565b5b1561049e576003925050506104a5565b6004925050505b919050565b60006104b68383611796565b905092915050565b600090565b6000806000808581526020019081526020016000209050600160058111156104ee576104ed612402565b5b6104f785610366565b600581111561050957610508612402565b5b14610549576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161054090612d4a565b60405180910390fd5b6000610577338360010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff166117fe565b9050600081116105bc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105b390612db6565b60405180910390fd5b6105c885338684611925565b3373ffffffffffffffffffffffffffffffffffffffff167f251f168c3d37dca4f3922f4aa12852da0c3de8ef70710e0cf58eba85805168a28686604051610610929190612de5565b60405180910390a2809250505092915050565b61062b612039565b6000808381526020019081526020016000206040518060e0016040529081600082015481526020016001820160009054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160089054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160109054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160189054906101000a900460ff161515151581526020016001820160199054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250509050919050565b6000610785611ad8565b73ffffffffffffffffffffffffffffffffffffffff166324d7806c336040518263ffffffff1660e01b81526004016107bd91906128b4565b602060405180830381865afa1580156107da573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107fe9190612e3a565b61083d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161083490612eb3565b60405180910390fd5b43881161087f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161087690612f1f565b60405180910390fd5b8484905087879050146108c7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108be90612fb1565b60405180910390fd5b82829050878790501461090f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161090690613043565b60405180910390fd5b6000886040516020016109229190613084565b6040516020818303038152906040528051906020012060001c90506000600460008b815260200190815260200160002060405180608001604052908160008201548152602001600182018054806020026020016040519081016040528092919081815260200182805480156109b657602002820191906000526020600020905b8154815260200190600101908083116109a2575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610a90578382906000526020600020018054610a03906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054610a2f906130ce565b8015610a7c5780601f10610a5157610100808354040283529160200191610a7c565b820191906000526020600020905b815481529060010190602001808311610a5f57829003601f168201915b5050505050815260200190600101906109e4565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015610b69578382906000526020600020018054610adc906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054610b08906130ce565b8015610b555780601f10610b2a57610100808354040283529160200191610b55565b820191906000526020600020905b815481529060010190602001808311610b3857829003601f168201915b505050505081526020019060010190610abd565b505050508152505090506000816000015114610bba576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bb19061314b565b60405180910390fd5b600081602001515114610c02576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bf9906131b7565b60405180910390fd5b600081604001515114610c4a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c4190613249565b60405180910390fd5b600081606001515114610c92576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c89906132b5565b60405180910390fd5b6000600560008481526020019081526020016000206040518060800160405290816000820154815260200160018201805480602002602001604051908101604052809291908181526020018280548015610d0b57602002820191906000526020600020905b815481526020019060010190808311610cf7575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610de5578382906000526020600020018054610d58906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054610d84906130ce565b8015610dd15780601f10610da657610100808354040283529160200191610dd1565b820191906000526020600020905b815481529060010190602001808311610db457829003601f168201915b505050505081526020019060010190610d39565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015610ebe578382906000526020600020018054610e31906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054610e5d906130ce565b8015610eaa5780601f10610e7f57610100808354040283529160200191610eaa565b820191906000526020600020905b815481529060010190602001808311610e8d57829003601f168201915b505050505081526020019060010190610e12565b505050508152505090506000816000015114610f0f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f0690613321565b60405180910390fd5b600081602001515114610f57576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f4e906133b3565b60405180910390fd5b600081604001515114610f9f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f9690613445565b60405180910390fd5b600081606001515114610fe7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fde906134d7565b60405180910390fd5b8a816000018181525050898980806020026020016040519081016040528093929190818152602001838360200280828437600081840152601f19601f82011690508083019250505050505050816020018190525087879061104891906136da565b816040018190525085859061105d9190613843565b8160600181905250806005600085815260200190815260200160002060008201518160000155602082015181600101908051906020019061109f9291906120ae565b5060408201518160020190805190602001906110bc9291906120fb565b5060608201518160030190805190602001906110d9929190612154565b509050506110e683611b02565b50827fc2c021f5d73c63c481d336fbbafec58f694fc45095f00b02d2deb8cca59afe0760405160405180910390a2829350505050979650505050505050565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000606080606060006004600087815260200190815260200160002060405180608001604052908160008201548152602001600182018054806020026020016040519081016040528092919081815260200182805480156111cf57602002820191906000526020600020905b8154815260200190600101908083116111bb575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b828210156112a957838290600052602060002001805461121c906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054611248906130ce565b80156112955780601f1061126a57610100808354040283529160200191611295565b820191906000526020600020905b81548152906001019060200180831161127857829003601f168201915b5050505050815260200190600101906111fd565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b828210156113825783829060005260206000200180546112f5906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054611321906130ce565b801561136e5780601f106113435761010080835404028352916020019161136e565b820191906000526020600020905b81548152906001019060200180831161135157829003601f168201915b5050505050815260200190600101906112d6565b5050505081525050905080600001518160200151826040015183606001519450945094509450509193509193565b60006113bc83836117fe565b905092915050565b60006001600360026113d4611ad8565b73ffffffffffffffffffffffffffffffffffffffff16633de6803b866040518263ffffffff1660e01b815260040161140c919061230e565b602060405180830381865afa158015611429573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061144d919061386d565b61145791906138c9565b611461919061393a565b61146b919061396b565b9050919050565b60006003600581111561148857611487612402565b5b61149183610366565b60058111156114a3576114a2612402565b5b146114e3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114da906139eb565b60405180910390fd5b6000806000848152602001908152602001600020905060018160010160196101000a81548160ff021916908315150217905550827f712ae1383f79ac853f8d882153778e0260ef8f03b504e2866e0593e04d2b291f60405160405180910390a261154c83611c7c565b5082915050919050565b6000806000808481526020019081526020016000206040518060e0016040529081600082015481526020016001820160009054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160089054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160109054906101000a900467ffffffffffffffff1667ffffffffffffffff1667ffffffffffffffff1681526020016001820160189054906101000a900460ff161515151581526020016001820160199054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681525050905060006116bd826020015167ffffffffffffffff166113c4565b9050600060026000846000015181526020019081526020016000206040518060600160405290816000820154815260200160018201548152602001600282015481525050905081816020015110158061172957508181600001518260400151611726919061396b565b10155b9350505050919050565b600080600260008481526020019081526020016000206040518060600160405290816000820154815260200160018201548152602001600282015481525050905080604001518160000151611788919061396b565b816020015111915050919050565b60006003600084815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b600080611809611ad8565b90508073ffffffffffffffffffffffffffffffffffffffff1663e62092be85856040518363ffffffff1660e01b8152600401611846929190613a0b565b602060405180830381865afa158015611863573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906118879190612e3a565b8061190a57508073ffffffffffffffffffffffffffffffffffffffff16635cadf6dd85856040518363ffffffff1660e01b81526004016118c8929190613a0b565b602060405180830381865afa1580156118e5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119099190612e3a565b5b1561191957600191505061191f565b60009150505b92915050565b60006002600086815260200190815260200160002090506119468585611796565b15611986576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161197d90613a80565b60405180910390fd5b60038360ff16106119cc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119c390613aec565b60405180910390fd5b6002808111156119df576119de612402565b5b60ff168360ff1603611a0b57818160000160008282546119ff919061396b565b92505081905550611a68565b60016002811115611a1f57611a1e612402565b5b60ff168360ff1603611a4b5781816001016000828254611a3f919061396b565b92505081905550611a67565b81816002016000828254611a5f919061396b565b925050819055505b5b60016003600087815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505050505050565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060008084815260200190815260200160002090506000816000015414611b60576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611b5790613b58565b60405180910390fd5b828160000181905550438160010160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550611b9c6104be565b43611ba7919061396b565b8160010160086101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550611bd9610311565b8160010160089054906101000a900467ffffffffffffffff1667ffffffffffffffff16611c06919061396b565b8160010160106101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550338160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082915050919050565b600080600560008481526020019081526020016000206040518060800160405290816000820154815260200160018201805480602002602001604051908101604052809291908181526020018280548015611cf657602002820191906000526020600020905b815481526020019060010190808311611ce2575b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015611dd0578382906000526020600020018054611d43906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054611d6f906130ce565b8015611dbc5780601f10611d9157610100808354040283529160200191611dbc565b820191906000526020600020905b815481529060010190602001808311611d9f57829003601f168201915b505050505081526020019060010190611d24565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015611ea9578382906000526020600020018054611e1c906130ce565b80601f0160208091040260200160405190810160405280929190818152602001828054611e48906130ce565b8015611e955780601f10611e6a57610100808354040283529160200191611e95565b820191906000526020600020905b815481529060010190602001808311611e7857829003601f168201915b505050505081526020019060010190611dfd565b5050505081525050905060056000848152602001908152602001600020600080820160009055600182016000611edf91906121ad565b600282016000611eef91906121ce565b600382016000611eff91906121ef565b505043816000015111611f47576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f3e90613bea565b60405180910390fd5b6000600460008360000151815260200190815260200160002090508381600001819055508160200151816001019080519060200190611f879291906120ae565b508160400151816002019080519060200190611fa49291906120fb565b508160600151816003019080519060200190611fc1929190612154565b5081600001517f229ec54ad02292d39d7686f16ddb7decef549d68d24423b7df15d57aead463d983602001518460400151856060015160405161200693929190613c0a565b60405180910390a28392505050919050565b60405180606001604052806000815260200160008152602001600081525090565b6040518060e0016040528060008152602001600067ffffffffffffffff168152602001600067ffffffffffffffff168152602001600067ffffffffffffffff168152602001600015158152602001600015158152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b8280548282559060005260206000209081019282156120ea579160200282015b828111156120e95782518255916020019190600101906120ce565b5b5090506120f79190612210565b5090565b828054828255906000526020600020908101928215612143579160200282015b828111156121425782518290816121329190613e02565b509160200191906001019061211b565b5b509050612150919061222d565b5090565b82805482825590600052602060002090810192821561219c579160200282015b8281111561219b57825182908161218b9190613f2f565b5091602001919060010190612174565b5b5090506121a99190612251565b5090565b50805460008255906000526020600020908101906121cb9190612210565b50565b50805460008255906000526020600020908101906121ec919061222d565b50565b508054600082559060005260206000209081019061220d9190612251565b50565b5b80821115612229576000816000905550600101612211565b5090565b5b8082111561224d57600081816122449190612275565b5060010161222e565b5090565b5b80821115612271576000818161226891906122b5565b50600101612252565b5090565b508054612281906130ce565b6000825580601f1061229357506122b2565b601f0160209004906000526020600020908101906122b19190612210565b5b50565b5080546122c1906130ce565b6000825580601f106122d357506122f2565b601f0160209004906000526020600020908101906122f19190612210565b5b50565b6000819050919050565b612308816122f5565b82525050565b600060208201905061232360008301846122ff565b92915050565b6000604051905090565b600080fd5b600080fd5b612346816122f5565b811461235157600080fd5b50565b6000813590506123638161233d565b92915050565b60006020828403121561237f5761237e612333565b5b600061238d84828501612354565b91505092915050565b61239f816122f5565b82525050565b6060820160008201516123bb6000850182612396565b5060208201516123ce6020850182612396565b5060408201516123e16040850182612396565b50505050565b60006060820190506123fc60008301846123a5565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b6006811061244257612441612402565b5b50565b600081905061245382612431565b919050565b600061246382612445565b9050919050565b61247381612458565b82525050565b600060208201905061248e600083018461246a565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006124bf82612494565b9050919050565b6124cf816124b4565b81146124da57600080fd5b50565b6000813590506124ec816124c6565b92915050565b6000806040838503121561250957612508612333565b5b600061251785828601612354565b9250506020612528858286016124dd565b9150509250929050565b60008115159050919050565b61254781612532565b82525050565b6000602082019050612562600083018461253e565b92915050565b600060ff82169050919050565b61257e81612568565b811461258957600080fd5b50565b60008135905061259b81612575565b92915050565b600080604083850312156125b8576125b7612333565b5b60006125c685828601612354565b92505060206125d78582860161258c565b9150509250929050565b600067ffffffffffffffff82169050919050565b6125fe816125e1565b82525050565b61260d81612532565b82525050565b61261c816124b4565b82525050565b60e0820160008201516126386000850182612396565b50602082015161264b60208501826125f5565b50604082015161265e60408501826125f5565b50606082015161267160608501826125f5565b5060808201516126846080850182612604565b5060a082015161269760a0850182612604565b5060c08201516126aa60c0850182612613565b50505050565b600060e0820190506126c56000830184612622565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126126f0576126ef6126cb565b5b8235905067ffffffffffffffff81111561270d5761270c6126d0565b5b602083019150836020820283011115612729576127286126d5565b5b9250929050565b60008083601f840112612746576127456126cb565b5b8235905067ffffffffffffffff811115612763576127626126d0565b5b60208301915083602082028301111561277f5761277e6126d5565b5b9250929050565b60008083601f84011261279c5761279b6126cb565b5b8235905067ffffffffffffffff8111156127b9576127b86126d0565b5b6020830191508360208202830111156127d5576127d46126d5565b5b9250929050565b60008060008060008060006080888a0312156127fb576127fa612333565b5b60006128098a828b01612354565b975050602088013567ffffffffffffffff81111561282a57612829612338565b5b6128368a828b016126da565b9650965050604088013567ffffffffffffffff81111561285957612858612338565b5b6128658a828b01612730565b9450945050606088013567ffffffffffffffff81111561288857612887612338565b5b6128948a828b01612786565b925092505092959891949750929550565b6128ae816124b4565b82525050565b60006020820190506128c960008301846128a5565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60006129078383612396565b60208301905092915050565b6000602082019050919050565b600061292b826128cf565b61293581856128da565b9350612940836128eb565b8060005b8381101561297157815161295888826128fb565b975061296383612913565b925050600181019050612944565b5085935050505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b60005b838110156129e45780820151818401526020810190506129c9565b60008484015250505050565b6000601f19601f8301169050919050565b6000612a0c826129aa565b612a1681856129b5565b9350612a268185602086016129c6565b612a2f816129f0565b840191505092915050565b6000612a468383612a01565b905092915050565b6000602082019050919050565b6000612a668261297e565b612a708185612989565b935083602082028501612a828561299a565b8060005b85811015612abe5784840389528151612a9f8582612a3a565b9450612aaa83612a4e565b925060208a01995050600181019050612a86565b50829750879550505050505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b6000612b2382612afc565b612b2d8185612b07565b9350612b3d8185602086016129c6565b612b46816129f0565b840191505092915050565b6000612b5d8383612b18565b905092915050565b6000602082019050919050565b6000612b7d82612ad0565b612b878185612adb565b935083602082028501612b9985612aec565b8060005b85811015612bd55784840389528151612bb68582612b51565b9450612bc183612b65565b925060208a01995050600181019050612b9d565b50829750879550505050505092915050565b6000608082019050612bfc60008301876122ff565b8181036020830152612c0e8186612920565b90508181036040830152612c228185612a5b565b90508181036060830152612c368184612b72565b905095945050505050565b60008060408385031215612c5857612c57612333565b5b6000612c66858286016124dd565b9250506020612c7785828601612354565b9150509250929050565b600082825260208201905092915050565b7f70726f706f73616c206973206e6f742065786973747300000000000000000000600082015250565b6000612cc8601683612c81565b9150612cd382612c92565b602082019050919050565b60006020820190508181036000830152612cf781612cbb565b9050919050565b7f70726f706f73616c206973206e6f742061637469766500000000000000000000600082015250565b6000612d34601683612c81565b9150612d3f82612cfe565b602082019050919050565b60006020820190508181036000830152612d6381612d27565b9050919050565b7f6e6f20766f746520726967687400000000000000000000000000000000000000600082015250565b6000612da0600d83612c81565b9150612dab82612d6a565b602082019050919050565b60006020820190508181036000830152612dcf81612d93565b9050919050565b612ddf81612568565b82525050565b6000604082019050612dfa60008301856122ff565b612e076020830184612dd6565b9392505050565b612e1781612532565b8114612e2257600080fd5b50565b600081519050612e3481612e0e565b92915050565b600060208284031215612e5057612e4f612333565b5b6000612e5e84828501612e25565b91505092915050565b7f4f6e6c792061646d696e2063616e206163636573730000000000000000000000600082015250565b6000612e9d601583612c81565b9150612ea882612e67565b602082019050919050565b60006020820190508181036000830152612ecc81612e90565b9050919050565b7f626c6f636b206e756d62657220697320616c7265616479207061737300000000600082015250565b6000612f09601c83612c81565b9150612f1482612ed3565b602082019050919050565b60006020820190508181036000830152612f3881612efc565b9050919050565b7f6c656e67746873206f66205f616d6f756e747320616e64205f7363726970745460008201527f797065732073686f756c6420626520657175616c000000000000000000000000602082015250565b6000612f9b603483612c81565b9150612fa682612f3f565b604082019050919050565b60006020820190508181036000830152612fca81612f8e565b9050919050565b7f6c656e67746873206f66205f616d6f756e747320616e64205f7363726970747360008201527f2073686f756c6420626520657175616c00000000000000000000000000000000602082015250565b600061302d603083612c81565b915061303882612fd1565b604082019050919050565b6000602082019050818103600083015261305c81613020565b9050919050565b6000819050919050565b61307e613079826122f5565b613063565b82525050565b6000613090828461306d565b60208201915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806130e657607f821691505b6020821081036130f9576130f861309f565b5b50919050565b7f6d696e7420697320616c72656164792063726561746564000000000000000000600082015250565b6000613135601783612c81565b9150613140826130ff565b602082019050919050565b6000602082019050818103600083015261316481613128565b9050919050565b7f6c697374206f6620616d6f756e74732073686f756c6420626520656d70747900600082015250565b60006131a1601f83612c81565b91506131ac8261316b565b602082019050919050565b600060208201905081810360008301526131d081613194565b9050919050565b7f6c697374206f662073637269707454797065732073686f756c6420626520656d60008201527f7074790000000000000000000000000000000000000000000000000000000000602082015250565b6000613233602383612c81565b915061323e826131d7565b604082019050919050565b6000602082019050818103600083015261326281613226565b9050919050565b7f6c697374206f6620736372697074732073686f756c6420626520656d70747900600082015250565b600061329f601f83612c81565b91506132aa82613269565b602082019050919050565b600060208201905081810360008301526132ce81613292565b9050919050565b7f70726f706f73616c20697320616c726561647920637265617465640000000000600082015250565b600061330b601b83612c81565b9150613316826132d5565b602082019050919050565b6000602082019050818103600083015261333a816132fe565b9050919050565b7f5b70726f706f73616c5d206c697374206f6620616d6f756e74732073686f756c60008201527f6420626520656d70747900000000000000000000000000000000000000000000602082015250565b600061339d602a83612c81565b91506133a882613341565b604082019050919050565b600060208201905081810360008301526133cc81613390565b9050919050565b7f5b70726f706f73616c5d206c697374206f66207363726970745479706573207360008201527f686f756c6420626520656d707479000000000000000000000000000000000000602082015250565b600061342f602e83612c81565b915061343a826133d3565b604082019050919050565b6000602082019050818103600083015261345e81613422565b9050919050565b7f5b70726f706f73616c5d206c697374206f6620736372697074732073686f756c60008201527f6420626520656d70747900000000000000000000000000000000000000000000602082015250565b60006134c1602a83612c81565b91506134cc82613465565b604082019050919050565b600060208201905081810360008301526134f0816134b4565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61352f826129f0565b810181811067ffffffffffffffff8211171561354e5761354d6134f7565b5b80604052505050565b6000613561612329565b905061356d8282613526565b919050565b600067ffffffffffffffff82111561358d5761358c6134f7565b5b602082029050602081019050919050565b600080fd5b600067ffffffffffffffff8211156135be576135bd6134f7565b5b6135c7826129f0565b9050602081019050919050565b82818337600083830152505050565b60006135f66135f1846135a3565b613557565b9050828152602081018484840111156136125761361161359e565b5b61361d8482856135d4565b509392505050565b600082601f83011261363a576136396126cb565b5b813561364a8482602086016135e3565b91505092915050565b600061366661366184613572565b613557565b90508083825260208201905060208402830185811115613689576136886126d5565b5b835b818110156136d057803567ffffffffffffffff8111156136ae576136ad6126cb565b5b8086016136bb8982613625565b8552602085019450505060208101905061368b565b5050509392505050565b60006136e7368484613653565b905092915050565b600067ffffffffffffffff82111561370a576137096134f7565b5b602082029050602081019050919050565b600067ffffffffffffffff821115613736576137356134f7565b5b61373f826129f0565b9050602081019050919050565b600061375f61375a8461371b565b613557565b90508281526020810184848401111561377b5761377a61359e565b5b6137868482856135d4565b509392505050565b600082601f8301126137a3576137a26126cb565b5b81356137b384826020860161374c565b91505092915050565b60006137cf6137ca846136ef565b613557565b905080838252602082019050602084028301858111156137f2576137f16126d5565b5b835b8181101561383957803567ffffffffffffffff811115613817576138166126cb565b5b808601613824898261378e565b855260208501945050506020810190506137f4565b5050509392505050565b60006138503684846137bc565b905092915050565b6000815190506138678161233d565b92915050565b60006020828403121561388357613882612333565b5b600061389184828501613858565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006138d4826122f5565b91506138df836122f5565b92508282026138ed816122f5565b915082820484148315176139045761390361389a565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000613945826122f5565b9150613950836122f5565b9250826139605761395f61390b565b5b828204905092915050565b6000613976826122f5565b9150613981836122f5565b92508282019050808211156139995761399861389a565b5b92915050565b7f50726f706f73616c206973206e6f742073756363657373656400000000000000600082015250565b60006139d5601983612c81565b91506139e08261399f565b602082019050919050565b60006020820190508181036000830152613a04816139c8565b9050919050565b6000604082019050613a2060008301856128a5565b613a2d60208301846122ff565b9392505050565b7f616c726561647920766f74650000000000000000000000000000000000000000600082015250565b6000613a6a600c83612c81565b9150613a7582613a34565b602082019050919050565b60006020820190508181036000830152613a9981613a5d565b9050919050565b7f696e76616c696420766f74650000000000000000000000000000000000000000600082015250565b6000613ad6600c83612c81565b9150613ae182613aa0565b602082019050919050565b60006020820190508181036000830152613b0581613ac9565b9050919050565b7f70726f706f73616c20616c726561647920657869737473000000000000000000600082015250565b6000613b42601783612c81565b9150613b4d82613b0c565b602082019050919050565b60006020820190508181036000830152613b7181613b35565b9050919050565b7f70726f706f73616c206d757374206265206164646564206265666f7265206d6960008201527f6e74696e6720626c6f636b000000000000000000000000000000000000000000602082015250565b6000613bd4602b83612c81565b9150613bdf82613b78565b604082019050919050565b60006020820190508181036000830152613c0381613bc7565b9050919050565b60006060820190508181036000830152613c248186612920565b90508181036020830152613c388185612a5b565b90508181036040830152613c4c8184612b72565b9050949350505050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613cb87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613c7b565b613cc28683613c7b565b95508019841693508086168417925050509392505050565b6000819050919050565b6000613cff613cfa613cf5846122f5565b613cda565b6122f5565b9050919050565b6000819050919050565b613d1983613ce4565b613d2d613d2582613d06565b848454613c88565b825550505050565b600090565b613d42613d35565b613d4d818484613d10565b505050565b5b81811015613d7157613d66600082613d3a565b600181019050613d53565b5050565b601f821115613db657613d8781613c56565b613d9084613c6b565b81016020851015613d9f578190505b613db3613dab85613c6b565b830182613d52565b50505b505050565b600082821c905092915050565b6000613dd960001984600802613dbb565b1980831691505092915050565b6000613df28383613dc8565b9150826002028217905092915050565b613e0b826129aa565b67ffffffffffffffff811115613e2457613e236134f7565b5b613e2e82546130ce565b613e39828285613d75565b600060209050601f831160018114613e6c5760008415613e5a578287015190505b613e648582613de6565b865550613ecc565b601f198416613e7a86613c56565b60005b82811015613ea257848901518255600182019150602085019450602081019050613e7d565b86831015613ebf5784890151613ebb601f891682613dc8565b8355505b6001600288020188555050505b505050505050565b60008190508160005260206000209050919050565b601f821115613f2a57613efb81613ed4565b613f0484613c6b565b81016020851015613f13578190505b613f27613f1f85613c6b565b830182613d52565b50505b505050565b613f3882612afc565b67ffffffffffffffff811115613f5157613f506134f7565b5b613f5b82546130ce565b613f66828285613ee9565b600060209050601f831160018114613f995760008415613f87578287015190505b613f918582613de6565b865550613ff9565b601f198416613fa786613ed4565b60005b82811015613fcf57848901518255600182019150602085019450602081019050613faa565b86831015613fec5784890151613fe8601f891682613dc8565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220c512dd325b5061ad025b1216e9a4d37d660e84a47daba75d91baa125a94261df64736f6c63430008120033";
const std::string supplyControlABI = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"block\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"},{\"indexed\":false,\"internalType\":\"string[]\",\"name\":\"scriptTypes\",\"type\":\"string[]\"},{\"indexed\":false,\"internalType\":\"bytes[]\",\"name\":\"scripts\",\"type\":\"bytes[]\"}],\"name\":\"MintAdded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalCancalled\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalCreated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"}],\"name\":\"ProposalExecuted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"voter\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint8\",\"name\":\"casted\",\"type\":\"uint8\"}],\"name\":\"VoteCast\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"uint8\",\"name\":\"support\",\"type\":\"uint8\"}],\"name\":\"castVote\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"execute\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_block\",\"type\":\"uint256\"}],\"name\":\"getMint\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"},{\"internalType\":\"string[]\",\"name\":\"scriptTypes\",\"type\":\"string[]\"},{\"internalType\":\"bytes[]\",\"name\":\"scripts\",\"type\":\"bytes[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"getProposalMeta\",\"outputs\":[{\"components\":[{\"internalType\":\"uint256\",\"name\":\"proposalID\",\"type\":\"uint256\"},{\"internalType\":\"uint64\",\"name\":\"proposedAt\",\"type\":\"uint64\"},{\"internalType\":\"uint64\",\"name\":\"voteStart\",\"type\":\"uint64\"},{\"internalType\":\"uint64\",\"name\":\"voteEnd\",\"type\":\"uint64\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"executed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"proposer\",\"type\":\"address\"}],\"internalType\":\"structVotable.ProposalMeta\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"getProposalVote\",\"outputs\":[{\"components\":[{\"internalType\":\"uint256\",\"name\":\"againstVotes\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"forVotes\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"abstainVotes\",\"type\":\"uint256\"}],\"internalType\":\"structGovVotable.ProposalVote\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"timepoint\",\"type\":\"uint256\"}],\"name\":\"getVotes\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"hasVoted\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_block\",\"type\":\"uint256\"},{\"internalType\":\"uint256[]\",\"name\":\"_amounts\",\"type\":\"uint256[]\"},{\"internalType\":\"string[]\",\"name\":\"_scriptTypes\",\"type\":\"string[]\"},{\"internalType\":\"bytes[]\",\"name\":\"_scripts\",\"type\":\"bytes[]\"}],\"name\":\"propose\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"timepoint\",\"type\":\"uint256\"}],\"name\":\"quorum\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"proposalId\",\"type\":\"uint256\"}],\"name\":\"status\",\"outputs\":[{\"internalType\":\"enumIVotable.ProposalStatus\",\"name\":\"\",\"type\":\"uint8\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"votingDeley\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"votingPeriod\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"}]";
const ContractABI contractSupplyControlABI = supplyControlABI;

FVMSupplyControl::FVMSupplyControl()
{
    supplyControlAddress = uintToh160(Params().GetConsensus().supplyControlAddress);
}

bool FVMSupplyControl::GetMint(int nHeight, std::vector<Mint> &out, CChainState &chain) {
    const static std::string method = "getMint";
    const auto abi = contractSupplyControlABI[method];

    std::vector<std::vector<std::string>> inputValues = {
        {i64tostr(nHeight)},
    };

    std::vector<ParameterABI::ErrorType> inputErrors;
    std::string inputData;

    if (!abi.abiIn(inputValues, inputData, inputErrors)) {
        return error("Fail to constuct input data");
    }

    std::vector<ResultExecute> execResults;
    {
        LOCK(cs_main);
        execResults = CallContract(supplyControlAddress, ParseHex(inputData), chain);
    }

    if (execResults.size() < 1) {
        return error("Fail to CallContract to get mint requests");
    }
    
    std::string outputData = HexStr(execResults[0].execRes.output);
    std::vector<std::vector<std::string>> outputValues;
    std::vector<ParameterABI::ErrorType> outputErrors;
    if (!abi.abiOut(outputData, outputValues, outputErrors)) {
        return error("Failed to deserialize get mint output parameters");
    }

    if (outputValues.size() != abi.outputs.size()) {
        return error("Failed to deserialize get poa output, size doesn't match");
    }

    std::vector<CAmount> amounts;
    std::vector<std::string> scriptsTypes;
    std::vector<CScript> scripts;
    try {
        for (std::size_t i = 0; i < outputValues.size(); i++) {

            std::vector<std::string> value = outputValues[i];

            std::string name = abi.outputs[i].name;
            if (name == "proposalId") {
                // don't need it now
            } else if (name == "amounts") {
                for (auto const &v: value) {
                    amounts.emplace_back(atoi64(v));
                }
            } else if (name == "scriptTypes") {
                scriptsTypes = value;
            } else if (name == "scripts") {
                for (auto const &v: value) {
                    auto script = ParseHex(v);
                    scripts.emplace_back(script.begin(), script.end());
                }
            } else {
                return error("Invalid get supply control output name");
            }
        }
    } catch(...) {
        return error("Invalid get supply control");
    }

    if (amounts.size() != scriptsTypes.size()) {
        return error("Invalid script types size");
    }

    if (amounts.size() != scripts.size()) {
        return error("Invalid scripts size");
    }

    for (size_t i = 0; i < amounts.size(); i++) {
        out.emplace_back(scriptsTypes[i], scripts[i], amounts[i]);
    }

    return true;
}
